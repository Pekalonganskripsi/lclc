<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - LCious Admin</title>
    <link rel="stylesheet" href="/assets/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar glass-container">
        <a href="/" class="navbar-brand">
            <span><i class="fas fa-disco-ball"></i></span>
            LCious Admin
        </a>
        <div class="navbar-links">
            <a href="/admin/dashboard.html">Dashboard</a>
            <a href="/admin/bookings.html">Manage Bookings</a>
            <a href="/admin/reports.html">Reports</a>
            <a href="#" id="logout-link">Logout</a>
        </div>
    </nav>

    <div class="container">
        <h1 class="neon-text" style="text-align: center; margin-bottom: 30px;">Admin Reports</h1>
        
        <!-- Revenue Summary -->
        <div class="glass-container" style="margin-bottom: 30px;">
            <h2 class="neon-text">Revenue Summary</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="card">
                    <h3>Total Revenue</h3>
                    <p style="font-size: 1.8rem; color: var(--gold-highlight); font-weight: bold;" id="total-revenue">Rp. 0</p>
                </div>
                <div class="card">
                    <h3>Total Bookings</h3>
                    <p style="font-size: 1.8rem; color: var(--secondary); font-weight: bold;" id="total-bookings">0</p>
                </div>
            </div>
        </div>
        
        <!-- Daily Revenue Chart -->
        <div class="glass-container" style="margin-bottom: 30px;">
            <h2 class="neon-text">Daily Revenue (Last 7 Days)</h2>
            <div id="daily-revenue-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="daily-revenue-body">
                        <!-- Daily revenue will be loaded here -->
                        <tr>
                            <td colspan="2" style="text-align: center;">Loading revenue data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Booking Status Distribution -->
        <div class="glass-container" style="margin-bottom: 30px;">
            <h2 class="neon-text">Booking Status Distribution</h2>
            <div id="booking-status-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px;">
                <!-- Booking status distribution will be loaded here -->
                <div class="card">
                    <h3>Loading...</h3>
                    <p style="font-size: 1.5rem; font-weight: bold;">0</p>
                </div>
            </div>
        </div>
        
        <!-- Top LCs -->
        <div class="glass-container" style="margin-bottom: 30px;">
            <h2 class="neon-text">Top LCs by Bookings</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>LC Name</th>
                        <th>Bookings</th>
                        <th>Total Revenue</th>
                    </tr>
                </thead>
                <tbody id="top-lcs-body">
                    <!-- Top LCs will be loaded here -->
                    <tr>
                        <td colspan="4" style="text-align: center;">Loading LC data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Room Popularity -->
        <div class="glass-container">
            <h2 class="neon-text">Room Popularity</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Room Name</th>
                        <th>Number of Bookings</th>
                    </tr>
                </thead>
                <tbody id="room-popularity-body">
                    <!-- Room popularity will be loaded here -->
                    <tr>
                        <td colspan="2" style="text-align: center;">Loading room data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 LCious. All rights reserved. | Admin Portal</p>
    </footer>

    <script src="/assets/script.js"></script>
    <script>
        // Check if user is logged in
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login.html';
        }

        // Logout functionality
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = '/admin/login.html';
        });

        // Fetch and display report data
        async function loadReports() {
            try {
                const response = await fetch('/api/admin/reports', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const reports = data.reports;
                    
                    // Update revenue summary
                    document.getElementById('total-revenue').textContent = 'Rp. ' + parseInt(reports.total_revenue).toLocaleString();
                    
                    // Calculate total bookings
                    const totalBookings = Object.values(reports.bookings_by_status).reduce((sum, count) => sum + count, 0);
                    document.getElementById('total-bookings').textContent = totalBookings;
                    
                    // Update daily revenue table
                    const dailyRevenueBody = document.getElementById('daily-revenue-body');
                    dailyRevenueBody.innerHTML = '';
                    reports.revenue_by_date.forEach(day => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(day.date).toLocaleDateString()}</td>
                            <td>Rp. ${parseInt(day.daily_revenue).toLocaleString()}</td>
                        `;
                        dailyRevenueBody.appendChild(row);
                    });
                    
                    // Update booking status distribution
                    const bookingStatusContainer = document.getElementById('booking-status-container');
                    bookingStatusContainer.innerHTML = '';
                    for (const [status, count] of Object.entries(reports.bookings_by_status)) {
                        const statusCard = document.createElement('div');
                        statusCard.className = 'card';
                        statusCard.innerHTML = `
                            <h3>${status}</h3>
                            <p style="font-size: 1.5rem; font-weight: bold;">${count}</p>
                        `;
                        bookingStatusContainer.appendChild(statusCard);
                    }
                    
                    // Update top LCs table
                    const topLCsBody = document.getElementById('top-lcs-body');
                    topLCsBody.innerHTML = '';
                    reports.top_lcs.forEach((lc, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${lc.name}</td>
                            <td>${lc.booking_count}</td>
                            <td>Rp. ${parseInt(lc.total_revenue || 0).toLocaleString()}</td>
                        `;
                        topLCsBody.appendChild(row);
                    });
                    
                    // Update room popularity table
                    const roomPopularityBody = document.getElementById('room-popularity-body');
                    roomPopularityBody.innerHTML = '';
                    reports.room_popularity.forEach(room => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${room.name}</td>
                            <td>${room.booking_count}</td>
                        `;
                        roomPopularityBody.appendChild(row);
                    });
                } else {
                    // Handle error
                    document.getElementById('daily-revenue-body').innerHTML = '<tr><td colspan="2" style="text-align: center;">Failed to load revenue data</td></tr>';
                    document.getElementById('booking-status-container').innerHTML = '<div class="card"><h3>Error</h3><p style="font-size: 1.5rem; font-weight: bold;">Failed to load status data</p></div>';
                    document.getElementById('top-lcs-body').innerHTML = '<tr><td colspan="4" style="text-align: center;">Failed to load LC data</td></tr>';
                    document.getElementById('room-popularity-body').innerHTML = '<tr><td colspan="2" style="text-align: center;">Failed to load room data</td></tr>';
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                
                // Update all sections with error messages
                document.getElementById('daily-revenue-body').innerHTML = '<tr><td colspan="2" style="text-align: center;">An error occurred while loading revenue data</td></tr>';
                document.getElementById('booking-status-container').innerHTML = '<div class="card"><h3>Error</h3><p style="font-size: 1.5rem; font-weight: bold;">An error occurred while loading status data</p></div>';
                document.getElementById('top-lcs-body').innerHTML = '<tr><td colspan="4" style="text-align: center;">An error occurred while loading LC data</td></tr>';
                document.getElementById('room-popularity-body').innerHTML = '<tr><td colspan="2" style="text-align: center;">An error occurred while loading room data</td></tr>';
            }
        }

        // Load reports when page loads
        document.addEventListener('DOMContentLoaded', loadReports);
    </script>
</body>
</html>